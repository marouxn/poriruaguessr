<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PoriruaGuessr</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <style>
        #map {
            height: 100%;
            min-height: 400px;
            width: 100%;
            border-radius: 0.5rem; 
        }
        .container-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1.5rem;
        }
        @media (min-width: 1024px) {
            .container-grid {
                grid-template-columns: 1fr 1fr;
            }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen font-sans p-4 sm:p-8">
    <div class="max-w-6xl mx-auto">
        
        <header class="text-center mb-8">
            <h1 class="text-4xl font-extrabold text-blue-800">PoriruaGuessr</h1>
            <div id="score-display" class="mt-4 text-xl font-semibold text-gray-700">
                Score: 0 | Round: 0/5
            </div>
        </header>

        <main>
            <div class="container-grid">
                
                <div id="game-controls" class="bg-white p-4 rounded-xl shadow-lg flex flex-col items-center justify-center h-full min-h-80">
                    <img id="current-photo" src="https://placehold.co/800x600/3B82F6/ffffff?text=Click+Start+Game" alt="Location Photo" class="w-full h-auto max-h-[60vh] object-cover rounded-lg shadow-md"/>
                    
                    <button id="next-button" class="mt-6 px-8 py-4 bg-green-600 text-white font-bold text-xl rounded-full shadow-lg hover:bg-green-700 transition duration-300 transform hover:scale-105" disabled>
                        Start Game
                    </button>

                    <div id="message-box" class="mt-4 text-lg font-medium text-blue-500">Press "Start Game" to load the first image.</div>
                </div>

                <div class="bg-white p-4 rounded-xl shadow-lg">
                    <div id="map"></div>
                </div>
            </div>
            
            <div id="results-area" class="mt-8 bg-white p-6 rounded-xl shadow-xl hidden">
                <h2 class="text-2xl font-bold text-center text-gray-700 mb-4">Round Results</h2>
                <div class="flex justify-around text-center">
                    <div class="text-xl">
                        <div id="guess-distance" class="font-bold text-red-500">-- km</div>
                        <p class="text-gray-500">Distance Error</p>
                    </div>
                    <div class="text-xl">
                        <div id="round-score" class="font-bold text-green-600">-- points</div>
                        <p class="text-gray-500">Round Points</p>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <script>
        const PORIRUA_LOCATIONS = [
            { id: 1, lat: -41.13174021472082, lng: 174.8402156056182, img: "https://raw.githubusercontent.com/marouxn/poriruaguessr/main/bp_pataka.png" },
            { id: 2, lat: -41.12811327879896, lng: 174.83897766080273, img: "https://raw.githubusercontent.com/marouxn/poriruaguessr/main/mega_centre_carpark.png" },
            { id: 3, lat: -41.121502952714415, lng: 174.85595648825074, img: "https://raw.githubusercontent.com/marouxn/poriruaguessr/main/aotea_lagoon_carpark1.png" },
            { id: 4, lat: -41.12616626809668, lng: 174.85441915585383, img: "https://raw.githubusercontent.com/marouxn/poriruaguessr/main/aotea_college_student_carpark.png" },
            { id: 5, lat: -41.139522129549476, lng: 174.8421302512755, img: "https://raw.githubusercontent.com/marouxn/poriruaguessr/main/mobil_mcdonalds.png" },
            { id: 6, lat: -41.120764974663906, lng: 174.8677938055544, img: "https://raw.githubusercontent.com/marouxn/poriruaguessr/main/countdown_aotea.png" },
            { id: 7, lat: -41.11400074505956, lng: 174.89523835921838, img: "https://raw.githubusercontent.com/marouxn/poriruaguessr/main/whitby_collegiate.png" },
            { id: 8, lat: -41.12497121293986, lng: 174.85246329777547, img: "https://raw.githubusercontent.com/marouxn/poriruaguessr/main/adrenalin_forest_main_entrance.png" },
            { id: 9, lat: -41.1078801831559, lng: 174.8839185968863, img: "https://raw.githubusercontent.com/marouxn/poriruaguessr/main/browns_bay_lookout_11_mercury_way.jpg" },
            { id: 10, lat: -41.10760686648859, lng: 174.884254809293, img: "https://raw.githubusercontent.com/marouxn/poriruaguessr/main/zig_zag_entrance_51_leeward_drive.jpg" },
            { id: 11, lat: -41.1113677058637, lng: 174.88078160828948, img: "https://raw.githubusercontent.com/marouxn/poriruaguessr/main/woolwich_close_culdesac.jpg" },
            { id: 12, lat: -41.11178829995112, lng: 174.8816002102373, img: "https://raw.githubusercontent.com/marouxn/poriruaguessr/main/postgate_crossing.jpg" },
            { id: 13, lat: -41.10613941442738, lng: 174.88504426163854, img: "https://raw.githubusercontent.com/marouxn/poriruaguessr/main/marker_39_bosun_terrace.jpg" },
            { id: 14, lat: -41.12852157413451, lng: 174.8492316587177, img: "https://raw.githubusercontent.com/marouxn/poriruaguessr/main/john_burke_drive_playground.png" },
            { id: 15, lat: -41.113067034202714, lng: 174.88461367766013, img: "https://raw.githubusercontent.com/marouxn/poriruaguessr/main/marker_azimuth.jpg" },
            { id: 16, lat: -41.113544470258596, lng: 174.8670326575066, img: "https://raw.githubusercontent.com/marouxn/poriruaguessr/main/papakowhai_school_spey_place.png" },
            { id: 17, lat: -41.11317707885035, lng: 174.88234811872323, img: "https://raw.githubusercontent.com/marouxn/poriruaguessr/main/postgate_tunnel.jpg" },
            { id: 18, lat: -41.11890502882855, lng: 174.85984086504175, img: "https://raw.githubusercontent.com/marouxn/poriruaguessr/main/nz_police_museum.png" },
            { id: 19, lat: -41.13146185794431, lng: 174.8412333040931, img: "https://raw.githubusercontent.com/marouxn/poriruaguessr/main/paknsave_carpark.png" },
            { id: 20, lat: -41.113420389812745, lng: 174.88310909965924, img: "https://raw.githubusercontent.com/marouxn/poriruaguessr/main/omapere_bp_azimuth.jpg" },
            { id: 21, lat: -41.11312394651156, lng: 174.8844796893276, img: "https://raw.githubusercontent.com/marouxn/poriruaguessr/main/whitby_shared_pathway_azimuth.jpg" },
            { id: 22, lat: -41.13142188475112, lng: 174.83887008022532, img: "https://raw.githubusercontent.com/marouxn/poriruaguessr/main/pataka.png" },
            { id: 23, lat: -41.11276850578737, lng: 174.88627086211105, img: "https://raw.githubusercontent.com/marouxn/poriruaguessr/main/tree_tag_whitby_shared_pathway.jpg" },
            { id: 24, lat: -41.11268276953351, lng: 174.88649466187664, img: "https://raw.githubusercontent.com/marouxn/poriruaguessr/main/spinnaker_drive.jpg" },
            { id: 25, lat: -41.10668591975428, lng: 174.86897730322983, img: "https://raw.githubusercontent.com/marouxn/poriruaguessr/main/john_ryan_plumbing.png" },
            { id: 26, lat: -41.113375715030266, lng: 174.883721914049, img: "https://raw.githubusercontent.com/marouxn/poriruaguessr/main/azimuth.jpg" },
            { id: 27, lat: -41.10846654834844, lng: 174.83786438116599, img: "https://raw.githubusercontent.com/marouxn/poriruaguessr/main/whitehouse_road_shops" },

        ];
        
        const MAX_ROUNDS = 10;
        const PORIRUA_CENTER = [-41.1333, 174.85];

        let gameData = {
            score: 0,
            round: 0,
            currentLocation: null,
            locationsPlayed: [], 
            isGuessing: false
        };

        let map = null;
        let guessMarker = null; 
        let trueMarker = null;  
        let polyline = null;    

        function initMap() {
            if (map) map.remove();

            map = L.map('map', { 
                center: PORIRUA_CENTER, 
                zoom: 12, 
                zoomControl: true 
            });

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            map.on('click', handleGuess);
        }

        function clearMarkersAndLines() {
            if (guessMarker) map.removeLayer(guessMarker);
            if (trueMarker) map.removeLayer(trueMarker);
            if (polyline) map.removeLayer(polyline);
            guessMarker = null;
            trueMarker = null;
            polyline = null;
            map.setView(PORIRUA_CENTER, 12);
        }

        function updateScoreDisplay() {
            document.getElementById('score-display').innerText = `Score: ${gameData.score} | Round: ${gameData.round}/${MAX_ROUNDS}`;
        }

        function loadNewRound() {
            if (gameData.round >= MAX_ROUNDS) {
                endGame();
                return;
            }
            
            document.getElementById('results-area').classList.add('hidden');
            document.getElementById('next-button').innerText = 'Guess!';
            document.getElementById('next-button').disabled = true;
            document.getElementById('message-box').innerText = 'Click on the map to place your guess.';
            
            clearMarkersAndLines(); 

            let availableLocations = PORIRUA_LOCATIONS.filter(loc => !gameData.locationsPlayed.includes(loc.id));
            
            if (availableLocations.length > 0) {
                const randomIndex = Math.floor(Math.random() * availableLocations.length);
                gameData.currentLocation = availableLocations[randomIndex];
                gameData.locationsPlayed.push(gameData.currentLocation.id);
                gameData.round++;

                document.getElementById('current-photo').src = gameData.currentLocation.img;
                gameData.isGuessing = true;
                
                updateScoreDisplay();
            } else {
                endGame();
            }
        }

        function endGame() {
            document.getElementById('current-photo').src = "https://placehold.co/800x600/374151/ffffff?text=Game+Over!+Final+Score:"+gameData.score;
            document.getElementById('next-button').disabled = true;
            document.getElementById('next-button').innerText = 'Game Over';
            // Updated message to be cleaner
            document.getElementById('message-box').innerText = `Game Over! Final Score: ${gameData.score} points.`;
        }


        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = (lat2 - lat1) * (Math.PI / 180);
            const dLon = (lon2 - lon1) * (Math.PI / 180);
            const a = 
                Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(lat1 * (Math.PI / 180)) * Math.cos(lat2 * (Math.PI / 180)) * Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }

        function calculateRoundScore(distance) {
            const MAX_DISTANCE = 5;
            let roundPoints = 0;

            if (distance < MAX_DISTANCE) {
                roundPoints = Math.max(0, Math.round(1000 * (1 - (distance / MAX_DISTANCE))));
            }
            return roundPoints;
        }

        function handleGuess(e) {
            if (!gameData.isGuessing || !gameData.currentLocation) return;

            const guessLat = e.latlng.lat;
            const guessLng = e.latlng.lng;
            
            if (guessMarker) {
                guessMarker.setLatLng([guessLat, guessLng]);
            } else {
                guessMarker = L.marker([guessLat, guessLng]).addTo(map).bindPopup("Your Guess").openPopup();
            }
            
            const trueCoords = [gameData.currentLocation.lat, gameData.currentLocation.lng];
            if (!trueMarker) {
                trueMarker = L.marker(trueCoords, { 
                    icon: L.icon({
                        iconUrl: 'https://cdn.rawgit.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png',
                        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                        iconSize: [25, 41],
                        iconAnchor: [12, 41],
                        popupAnchor: [1, -34],
                        shadowSize: [41, 41]
                    }),
                }).addTo(map).bindPopup("True Location").openPopup();
            }

            const distance = calculateDistance(trueCoords[0], trueCoords[1], guessLat, guessLng);
            const roundPoints = calculateRoundScore(distance);

            gameData.score += roundPoints;
            gameData.isGuessing = false;
            
            if (polyline) map.removeLayer(polyline);
            polyline = L.polyline([trueCoords, [guessLat, guessLng]], { color: 'red', weight: 3, opacity: 0.7 }).addTo(map);
            const bounds = L.latLngBounds(trueCoords, [guessLat, guessLng]);
            map.fitBounds(bounds, { padding: [50, 50] });

            document.getElementById('guess-distance').innerText = `${distance.toFixed(2)} km`;
            document.getElementById('round-score').innerText = `${roundPoints} points`;
            document.getElementById('results-area').classList.remove('hidden');
            document.getElementById('next-button').disabled = false;
            document.getElementById('next-button').innerText = (gameData.round === MAX_ROUNDS) ? 'View Final Score' : 'Next Round';
            document.getElementById('message-box').innerText = 'Guess submitted! Press "Next Round" when ready.';

            updateScoreDisplay();
        }

        window.onload = function() {
            initMap();
            updateScoreDisplay();
            document.getElementById('next-button').disabled = false;
            document.getElementById('next-button').onclick = loadNewRound;
        };

    </script>
</body>
</html>
